<!--
params used here:
group
current_user
chats
-->
<% member = group.type == "friend" ? group.members(current_user).first : nil %>
<div class="flex flex-col h-full" data-controller="chat" data-group-id="<%= group.id %>">
  <!-- Active Chat Header -->
  <div class="p-4 border-b border-[var(--border-clr-subtle)] bg-[var(--background-clr-clear)] flex items-center space-x-4 flex-shrink-0">
    <button @click="activeChat = null" class="text-[var(--txt-clr-subtle)] md:hidden">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <div class="relative">
      <span class="h-10 w-10 rounded-full bg-[var(--background-clr-strong)] overflow-hidden flex items-center justify-center">
        <% if group.type == "friend" %>
          <% if member.profile_picture.attached? %>
            <%= image_tag url_for(member.profile_picture) %>
          <% else %>
            <%= icon(icon: :user_icon, options: {class: "fa-fw text-[var(--txt-clr-subtle)]"}) %>
          <% end %>
        <% else %>
        <% end %>
      </span>
      <!--Need to show if a person is online or not-->
      <span x-show="activeChat.online" x-cloak class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 ring-2 ring-white dark:ring-gray-800"></span>
    </div>
    <div>
      <p class="font-semibold text-[var(--txt-clr-strong)]"><%= group.type == "friend" ? member.username : group.name %></p>
      <p class="text-xs text-[var(--txt-clr-subtle)]">user online or offline</p>
    </div>
  </div>
  <!-- Chat Messages Area -->
  <div x-ref="chatArea" id="chat_scroll_area" class="bg-[var(--background-clr-clear)] flex-grow p-4 sm:p-6 overflow-y-auto overflow-x-hidden custom-scrollbar">
    <div id="chat_list_<%= group.id %>" class="space-y-2 h-full">
      <%# TODO: render _chat_list here and add unique id to the top div %>
      <% if chats.present? %>
        <%= render partial: "chat/chat_list", locals: { chats: chats } %>
      <% else %>
        <div id="empty_chat_window_<%= group.id %>" class="flex flex-col flex-grow items-center justify-center h-full w-full text-center text-[var(--txt-clr-subtle)]">
          <i class="fa-regular fa-comments fa-4x mb-4"></i>
          <h3 class="text-lg font-medium">Start a conversion</h3>
        </div>
      <% end %>
    </div>
  </div>
  <!-- Message Input Form -->
  <div class="p-4 bg-[var(--background-clr-clear)] border-t border-[var(--border-clr-subtle)] flex-shrink-0">
    <!-- Replying To Banner -->
    <div x-show="false" x-transition class="bg-[var(--background-clr-thick)] p-2 rounded-md mb-2 flex justify-between items-center">
      <div class="text-xs text-[var(--txt-clr-muted)] min-w-0">
        <p>Replying to <b x-text="replyingToMessage?.from === 'me' ? 'yourself' : activeChat.name"></b></p>
        <p class="italic truncate" x-text="replyingToMessage?.text"></p>
      </div>
      <button @click="replyingToMessage = null" class="p-1 rounded-full hover:bg[var(--background-clr-strong)]"><i class="fa-solid fa-xmark text-xs"></i></button>
    </div>
    <%= form_with url: chat_index_path(),
    id: "chat_form",
    method: :post, scope: :new_chat, 
    data:{
      group_id: group.id
    }, 
    class: "flex items-center space-x-3" do |f| %>
      <%= f.hidden_field :group_id, value: group.id %>
      <%= f.hidden_field :temporary_chat_id, value: "testing" %>
      <%= f.text_field :message, autocomplete: "off", class:"w-full px-4 py-2 border border-[var(--border-clr-default)] rounded-full text-sm bg-[var(--background-clr-thick)] focus:ring-[var(--primary-500)] focus:border-[var(--primary-500] focus:border-[var(--primary-500)]", placeholder:"Type a message..." %>
      <%= f.button class:"bg-[var(--primary-600)] text-white rounded-full h-10 w-10 flex-shrink-0 hover:bg-[var(--primary-700)] transition-colors focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:ring-offset-2",
      data:{action: "click->chat#append"} do %>
        <i class="fa-solid fa-paper-plane"></i>
      <% end %>
    <% end %>
  </div>
</div>
<template data-chat-form-target="chat_sent_template">
  <div id="{{CHAT_ID}}" class="group relative flex justify-end" data-date="{{DATE}}" data-chat-read="true">
    <!-- Message Bubble -->
    <div class="max-w-xs lg:max-w-md">
      <div class="px-4 py-2 rounded-2xl bg-[var(--primary-600)] text-[var(--txt-clr-default)] rounded-br-none">
        <!-- ** MODIFIED: Quoted Reply UI ** --> <!--TODO: Reply chat yet to implement-->
        <div x-show="false" class="mb-2 p-2 rounded-md border-l-4 bg-[var(--primary-500)]">
          <p class="text-xs font-semibold text-[var(--primary-100)]">Chat name</p>
          <p class="text-xs italic truncate text-[var(--primary-200)]">message reply to text</p>
        </div>
        <!-- Main Message Text -->
        <p class="text-sm">{{MESSAGE}}</p>
        <div class="flex items-center justify-end mt-1">
          <p class="text-xs text-[var(--txt-clr-muted)] mr-1.5">{{MESSAGE_TIME}}</p>
          <i class="fa-solid fa-clock-rotate-left text-[var(--txt-clr-muted)] text-sm"></i>
        </div>
      </div>
      <!-- Reactions Display --> <!--TODO: Reactions yet to implement-->
      <div x-show="false" x-cloak class="flex space-x-1 mt-1 justify-end">
        <!--Template for reaction (this needs ti )-->
        <div class="bg-gray-200 dark:bg-gray-600 rounded-full px-2 py-0.5 text-xs flex items-center">
          <span class="mr-1">emoji</span>
          <span class="font-semibold text-gray-700 dark:text-gray-200">count</span>
        </div>
        <!--Template for reaction end -->
      </div>
    </div>
  </div>
</template>
<template data-chat-target="chat_date">
  <div class="flex justify-center my-4 date-separator" data-date="{{DATE}}">
    <span class="bg-[var(--background-clr-strong)] text-[var(--txt-clr-muted)] text-xs font-semibold px-3 py-1 rounded-full">{{FORMATED_DATE}}</span>
  </div>
</template>
<template data-chat-target="chat_unread_bar">
  <div class="flex justify-center my-4 chat-unread-separator">
    <span class="bg-[var(--background-clr-strong)] text-[var(--txt-clr-muted)] text-xs font-semibold px-3 py-1 rounded-full">Unread Messages</span>
  </div>
</template>