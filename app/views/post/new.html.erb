<% content_for :page_javascript do %>
  <%= javascript_include_tag "post/new", "data-turbo-track": "reload" %>
<% end %>
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8" x-init="footer_active_tab = 'create_post'" x-data="post_new">
  <div class="bg-[var(--background-clr-clear)] p-6 sm:p-8 rounded-lg shadow-lg">
    <div class="mb-6">
      <h1 class="text-2xl sm:text-3xl font-bold text-[var(--txt-clr-strong)]">Create New Post</h1>
      <p class="text-sm text-[var(--txt-clr-subtle)] mt-1">Share your thoughts, images, or videos with the community.</p>
    </div>
    <%= form_with url: :post_index,model: @post, class:"space-y-6" do |form| %>
      <div>
        <label class="block text-sm font-medium text-[var(--txt-clr-default)] mb-2">Post Type</label>
        <div class="flex flex-wrap gap-y-2 gap-x-4">
          <label class="flex items-center space-x-2 cursor-pointer">
            <%= form.radio_button :content_type, "blog", "x-model"=>"postType", class:"focus:ring-[var(--primary-500)] bg-[var(--background-clr-thick)] h-4 w-4 text-[var(--primary-600)] border-[var(--border-clr-default)]", checked: true %>
            <span class="text-sm text-[var(--txt-clr-default)]">Blog Post</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <%= form.radio_button :content_type, "images", "x-model"=>"postType", class:"focus:ring-[var(--primary-500)] bg-[var(--background-clr-thick)] h-4 w-4 text-[var(--primary-600)] border-[var(--border-clr-default)]" %>
            <span class="text-sm text-[var(--txt-clr-default)]">Image(s)</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <%= form.radio_button :content_type, "video", "x-model"=>"postType", class:"focus:ring-[var(--primary-500)] bg-[var(--background-clr-thick)] h-4 w-4 text-[var(--primary-600)] border-[var(--border-clr-default)]" %>
            <span class="text-sm text-[var(--txt-clr-default)]">Video</span>
          </label>
        </div>
      </div>
      <div>
        <label for="post-title" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Title</label>
        <%= form.text_field :title, 
        placeholder: "Enter a catchy title for your post",
        class: "w-full px-4 py-2 border border-[var(--border-clr-default)] bg-[var(--background-clr-thick)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out" %>
      </div>
      <div>
        <label for="post-category" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Category</label>
        <%= form.select :content_category_id, 
        @content_categories.map { |c| [c.category, c.id] }, { include_blank: "Choose a Category" }, 
        class: "w-full px-4 py-2 border border-[var(--border-clr-default)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out bg-[var(--background-clr-thick)]" %>
      </div>
      <div x-show="postType === 'blog'" x-transition>
        <label for="post-content" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Content</label>
        <%= form.rich_text_area :description, 
        placeholder: "Start writing your amazing post here...",
        class:"border border-[var(--border-clr-default)] bg-[var(--background-clr-thick)] w-full p-4 focus:ring-0 rich-text-editor resize-y shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out bg-[var(--background-clr-clear)] trix-content" %>
        <p class="mt-2 text-xs text-[var(--txt-clr-subtle)]">You can use toolbar for formatting.</p>
      </div>
      <div x-show="postType === 'images'" x-transition>
        <div>
          <div class="flex justify-between items-center">
            <label for="image-upload" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Upload Images</label>
            <span class="text-xs text-[var(--txt-clr-subtle)]" x-text="`${imageFiles.length}/10`"></span>
          </div>
          <p x-show="image_error_message" x-text="image_error_message" class="text-red-500 text-sm"></p>
          <%= form.file_field :images, 
          accept: 'image/*', 
          multiple: true,
          "@change" => "
          if((imageFiles.length+$event.target.files.length)<=10){
            imageFiles = [...imageFiles, ...Array.from($event.target.files)]; 
          }
          else{
            image_error_message='You can only select 10 images'; 
            setTimeout(() => { image_error_message = null }, 4000);
          };
          $event.target.value = null; 
          ", 
          "x-ref" => "imageUploadInputRef",
          class: "hidden w-full text-sm text-[var(--txt-clr-subtle)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-[var(--primary-700)] hover:file:bg-[var(--primary-100)] cursor-pointer" %>
          <div class="image-preview-container">
            <template x-for="(file, index) in imageFiles" :key="index">
              <div class="image-preview-item">
                <img :src="URL.createObjectURL(file)" :alt="file.name" class="object-cover w-full h-full">
                <button @click="imageFiles.splice(index, 1); if (imageFiles.length === 0) $refs.imageUploadInputRef.value = null;" type="button" class="remove-btn" title="Remove image">&times;</button>
              </div>
            </template>
            <div x-show= "imageFiles.length <10 "
            @click="$refs.imageUploadInputRef.click()" 
            class="image-add-button border-dashed border-2 rounded-md border-[var(--primary-200)] p-2">
              <div class="bg-[var(--primary-200)] w-full h-full border rounded-md flex items-center justify-center">
                <%= icon(icon: :plus_icon, options:{class:"text-4xl text-[var(--txt-clr-inverted)]"}) %>
              </div>
            </div>
          </div>
          <p class="mt-2 text-xs text-[var(--txt-clr-subtle)]">You can upload 10 images (PNG, JPG, GIF).</p>
        </div>
        <div>
          <label for="post-title" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Description</label>
          <%= form.text_area :image_description, 
          placeholder: "Enter a description for your post",
          class: "w-full px-4 py-2 border border-[var(--border-clr-default)] bg-[var(--background-clr-thick)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out" %>
        </div>
      </div>
      <div x-show="postType === 'video'" x-transition>
        <label for="video-upload" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Upload Video</label>
        <%= form.file_field :video, 
        accept: 'video/mp4, video/webm, video/ogg', 
        multiple: false, direct_upload: true,
        class: "block w-full text-sm text-[var(--txt-clr-subtle)] file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-[var(--primary-700)] hover:file:bg-[var(--primary-100)] cursor-pointer",
        "@change" => "videoFile = $event.target.files[0];",
        "x-ref" => "videoUploadInputRef" %>
        <div x-show="videoFile && !isVideoUploading" class="mt-2">
          <video :src="videoFile ? URL.createObjectURL(videoFile) : null" controls class="w-full max-h-96 rounded-md border border-[var(--border-clr-default)]"></video>
          <p class="text-xs text-[var(--txt-clr-subtle)] mt-1" x-text="videoFile ? videoFile.name : ''"></p>
          <button @click="videoFile = null; $refs.videoUploadInputRef.value = null;" type="button" class="mt-1 text-xs text-red-600 hover:underline">Remove video</button>
        </div>
        <div x-show="isVideoUploading" class="mt-4">
          <div class="flex justify-between mb-1">
            <span class="text-xs font-medium text-[var(--primary-700)]">Uploading video...</span>
            <span class="text-xs font-medium text-[var(--primary-700)]" x-text="videoUploadProgress + '%'"></span>
          </div>
          <div class="w-full bg-[var(--background-clr-strong)] rounded-full h-2.5">
            <div class="bg-[var(--primary-600)] h-2.5 rounded-full transition-all duration-300 ease-out" :style="`width: ${videoUploadProgress}%`"></div>
          </div>
        </div>
        <p class="mt-2 text-xs text-[var(--txt-clr-subtle)]">Upload a single video file (MP4, WebM, Ogg).</p>
      </div>
      <div>
        <label for="post-title" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Description</label>
        <%= form.text_area :video_description, 
        placeholder: "Enter a description for your post",
        class: "w-full px-4 py-2 border border-[var(--border-clr-default)] bg-[var(--background-clr-thick)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out" %>
      </div>
      <!-- TODO: currently we are not having tags, it can be used on later stages-->
      <div>
        <label for="post-tags" class="block text-sm font-medium text-[var(--txt-clr-default)] mb-1">Tags (Optional)</label>
        <input
        type="text"
        name="post-tags"
        id="post-tags"
        placeholder="e.g., tech, programming, travel (comma-separated)"
        class="w-full px-4 py-2 border border-[var(--border-clr-default)] bg-[var(--background-clr-thick)] rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] transition duration-150 ease-in-out">
        </div>
        <div class="flex flex-col sm:flex-row sm:justify-end sm:space-x-3 space-y-3 sm:space-y-0 pt-4">
          <button
          :disabled="button_disable"
          :class="{'cursor-not-allowed' : button_disable}"
        type="button"
        class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-2 border border-[var(--border-clr-default)] shadow-sm text-sm font-medium rounded-md text-[var(--txt-clr-default)] bg-[var(--background-clr-clear)] hover:bg-[var(--background-clr-body)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition duration-150 ease-in-out">
            <%= icon(icon: :floppy_disk_icon, options:{class: "mr-2"}) %>Save Draft
          </button>
          <%= button_tag type: :submit,
          name: "status", 
          value: "published",
          ":disabled" => "button_disable",
          ":class" => "{'cursor-not-allowed' : button_disable}",
          "@click"=>"submit_post()",
          class: "w-full sm:w-auto inline-flex items-center justify-center px-6 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-[var(--txt-clr-inverted))] bg-[var(--primary-600)] hover:bg-[var(--primary-700)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition duration-150 ease-in-out" do %>
            <%= icon(icon: :paper_plane_icon, options:{class: "mr-2"}) %>
            <%= "Publish Post" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
