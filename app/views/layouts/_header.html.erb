<nav data-controller="header" class="bg-[var(--background-clr-clear)] shadow-md sticky top-0 z-40" 
x-data="{ 
  open: false, 
  dark_mode: false, 
  show_search: false,
  show_notification_web: false,
  show_notification_mobile: false,
  show_hamburger_menu: false,
  init()
  {
    this.$nextTick(() => { 
  this.dark_mode= (localStorage.getItem('dark_mode') != null ? (localStorage.getItem('dark_mode') == 'dark' ? true : false) : (window.matchMedia('(prefers-color-scheme: dark)') ? true : false) );  
  });
  },
  change_theme(event){
  console.log(event.srcElement.checked);
  if (event.srcElement.checked){
  this.dark_mode = true;
  localStorage.setItem('dark_mode', 'dark');
  if(!document.documentElement.classList.contains('dark')){
  document.documentElement.classList.add('dark')
  }
  document.documentElement.classList.remove('light')
  }
  else{
  localStorage.setItem('dark_mode', 'light');
  this.dark_mode = false;
  if(!document.documentElement.classList.contains('light')){
  document.documentElement.classList.add('light')
  }
  document.documentElement.classList.remove('dark')
  }
  }
  }" >
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex-shrink-0">
        <%= link_to root_path(), class:"flex items-center text-[var(--primary-600)] hover:text-[var(--primary-700)] transition duration-150 ease-in-out" do %>
          <%= image_tag("logo.png", alt: "K-loop Logo", class: "h-8 w-auto mr-2") %>
          <span class="text-2xl font-bold">k-loop</span>
        <% end %>
      </div>
      <div class="hidden md:flex flex-grow justify-center px-4">
        <div class="inset-y-0 mr-3 pl-3 flex items-center pointer-events-none">
          <%= icon(icon: :search_icon, options:{class:"text-[var(--txt-clr-lite)]"}) %>
        </div>
        <div class="relative w-full max-w-lg" @click.away="show_search = false">
          <div class="relative">
            <%= form_with url: search_index_path, method: :get do |f| %>
              <%= f.text_field :search_text,
              "@focus"=> "show_search = true",
              placeholder: "Search k-loop",
              data:{action: "input->header#seachOnChange", search_url_template: autocomplete_path(search_text:"PLACEHOLDER")},
              autocomplete: "off",
              class:"block w-full border border-[var(--border-clr-default)] rounded-md leading-5 bg-[var(--background-clr-clear)] placeholder-[var(--txt-clr-subtle)] focus:outline-none focus:placeholder-[var(--txt-clr-lite)] focus:ring-1 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm transition duration-150 ease-in-out" %>
            <% end %>
            <div x-show="show_search" x-cloak class=" absolute w-full left-0 mt-2 rounded-md shadow-lg py-1 bg-[var(--background-clr-clear)] ring-1 ring-[var(--border-clr-strong)] ring-opacity-5 z-10">
              <%= render partial: "shared/trending_posts", locals: {posts: [], user: current_user} %>
            </div>
          </div>
        </div>
      </div>
      <div class="hidden md:flex items-center space-x-4">
        <%= link_to new_post_path(),
            type: "button",
            class: "inline-flex items-center px-3 py-2 border border-[var(--border-clr-default)] shadow-sm text-sm leading-4 font-medium rounded-md text-[var(--txt-clr-default)] bg-[var(--background-clr-clear)] hover:bg-[var(--background-clr-body)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)] transition duration-150 ease-in-out" do %>
          <%= icon(icon: :plus_icon, options:{class: "text-[var(--txt-clr-subtle)] mr-1"}) %>
          Create Post
        <% end %>
        <div class="relative" @click.away="show_notification_web = false">
          <button type="button" @click="show_notification_web = !show_notification_web" class="p-1 w-8 h-8 rounded-full text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-subtle)] focus:outline-none focus:ring-2 focus:ring-[var(--primary-500)]">
            <%= icon(icon: :bell_icon, options:{class: "text-xl"}) %>
          </button>
          <div x-show="show_notification_web" x-cloak class="hidden md:block absolute w-96 mt-2 right-[-40px] rounded-md shadow-lg py-1 bg-[var(--background-clr-clear)] ring-1 ring-[var(--border-clr-strong)] ring-opacity-5 z-10">
            <div class="px-4 py-2 text-sm font-semibold text-[var(--txt-clr-strong)] border-b border-[var(--border-clr-subtle)]">
              Notifications
            </div>
            <div class="max-h-80 overflow-y-auto" id="notifications_list">
              <% current_user.notifications.order(created_at: :desc).each do |notification| %>
                <%= render partial: "shared/notification", locals:{notification: notification} %>
              <% end %>
            </div>
          </div>
        </div>
        <div class="relative">
          <div>
            <button @click="open = !open" type="button" class="bg-[var(--background-clr-clear)] rounded-full flex text-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]" id="user-menu-button" aria-expanded="false" aria-haspopup="true">
              <span class="sr-only">Open user menu</span>
              <span class="h-8 w-8 overflow-hidden rounded-full bg-[var(--background-clr-thick)] flex items-center justify-center">
                <% if current_user.profile_picture.attached? %>
                  <%= image_tag url_for(current_user.profile_picture) %>
                <% else %>
                  <%= icon(icon: :user_icon, options: {class: "fa-fw text-[var(--txt-clr-subtle)]"}) %>
                <% end %>
              </span>
            </button>
          </div>
          <div
            x-show="open"
            x-cloak
            x-transition:enter="transition ease-out duration-100"
            x-transition:enter-start="transform opacity-0 scale-95"
            x-transition:enter-end="transform opacity-100 scale-100"
            x-transition:leave="transition ease-in duration-75"
            x-transition:leave-start="transform opacity-100 scale-100"
            x-transition:leave-end="transform opacity-0 scale-95"
            @click.away="open = false"
            class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-[var(--background-clr-clear)] ring-1 ring-[var(--border-clr-strong)] ring-opacity-5 focus:outline-none z-10" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button" tabindex="-1" >
            <%= link_to  user_profile_path(id: current_user.id), class: "block px-4 py-2 text-sm text-[var(--txt-clr-default)] hover:bg-[var(--background-clr-thick)]", role:"menuitem", tabindex: "-1" do %>
              <%= icon(icon: :regular_user_icon, options:{class:"fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
              <%= "Your Profile" %>
            <% end %>
            <a href="#" class="block px-4 py-2 text-sm text-[var(--txt-clr-default)] hover:bg-[var(--background-clr-thick)]" role="menuitem" tabindex="-1" id="user-menu-item-1">
              <%= icon(icon: :gear_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
              Account Settings
            </a>
            <div class="border-t border-[var(--border-clr-subtle)] my-1"></div>
            <%= link_to site_settings_path(), class: "block rounded-md px-3 py-2 text-base font-medium text-[var(--txt-clr-muted)] hover:bg-[var(--background-clr-body)] hover:text-[var(--txt-clr-thick)]" do %>
              <%= icon(icon: :sliders_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
              Site Settings
            <% end %>
            <div class="flex px-4 py-2 items-center justify-between">
              <span class="flex-grow flex flex-col">
                <span class="text-sm font-medium text-[var(--txt-clr-default)]">Dark Mode</span>
              </span>
              <label 
            :class="{'bg-[var(--primary-600)]' : dark_mode==true, 'bg-[var(--background-clr-strong)]' : dark_mode==false}"
            class="relative inline-flex flex-shrink-0 items-center h-5 w-9 border-2 border-[var(--border-clr-default)] rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]">
                <input type="checkbox" class="w-0 h-0 opacity-0" :checked="dark_mode" @change="change_theme" >
                <span
              :class="{ 'translate-x-4': dark_mode==true, 'translate-x-0': dark_mode==false }"
              class="pointer-events-none inline-block h-3 w-3 rounded-full bg-[var(--background-clr-clear)] shadow transform ring-0 transition ease-in-out duration-200"></span>
              </label>
            </div>
            <div class="border-t border-[var(--border-clr-subtle)] my-1"></div>
            <%= link_to destroy_user_session_path(), data: { turbo_method: "delete" }, class: "block px-4 py-2 text-sm text-[var(--txt-clr-default)] hover:bg-[var(--background-clr-thick)]", role:"menuitem", tabindex: "-1" do %>
              <%= icon(icon: :arrow_right_from_bracket_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
              <%= "Sign out" %>
            <% end %>
          </div>
        </div>
      </div>
      <div class="-mr-2 flex md:hidden">
        <button type="button" @click="isSearchModalOpen = true" class="p-1 mr-2 rounded-full text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-subtle)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]">
          <span class="sr-only">Search</span>
          <%= icon(icon: :search_icon, options:{class:"text-xl"}) %>
        </button>
        <button type="button" @click="show_notification_mobile = !show_notification_mobile" class="p-1 rounded-full text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-subtle)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]">
          <%= icon(icon: :bell_icon, options:{class: "text-xl"}) %>
        </button>
        <button type="button" class="bg-[var(--background-clr-clear)] inline-flex items-center justify-center p-2 rounded-md text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-subtle)] hover:bg-[var(--background-clr-thick)] focus:outline-none focus:ring-2 focus:ring-inset focus:ring-[var(--primary-500)]" aria-controls="mobile-menu" aria-expanded="false" @click="show_hamburger_menu = !show_hamburger_menu">
          <span class="sr-only">Open main menu</span>
          <%= icon(icon: :hamburger_icon, options:{class:"text-xl block", id:"hamburger-icon"}) %>
        </button>
      </div>
    </div>
  </div>
  <!-- Mobile notification start-->
  <div
  x-show="show_notification_mobile"
  x-cloak
  x-transition:enter="transition ease-in-out duration-300"
  x-transition:leave="transition ease-in-out duration-300"
  class="fixed inset-0 z-40 md:hidden"
  style="display: none;"
>
    <div
    x-show="show_notification_mobile"
    x-transition:enter="ease-in-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in-out duration-300"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="show_notification_mobile = false"
    class="absolute inset-0 bg-[var(--background-clr-god)] bg-opacity-50"
  ></div>
    <div
    class="fixed top-0 right-0 h-full w-64 sm:w-80 bg-[var(--background-clr-clear)] shadow-xl z-50"
    x-show="show_notification_mobile"
    x-transition:enter="transition ease-in-out duration-300 transform"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in-out duration-300 transform"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
  >
      <div class="flex justify-between items-center p-4 border-b border-[var(--border-clr-subtle)]">
        <span class="font-semibold text-[var(--txt-clr-thick)]">Notification</span>
        <button type="button" class="p-2 text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-muted)]" @click="show_notification_mobile = false">
          <span class="sr-only">Close menu</span>
          <%# Your icon helper. I'll use a placeholder SVG for this example %>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    </div>
  </div>
  <!-- Mobile hamburger menu start -->
  <div
  x-show="show_hamburger_menu"
  x-cloak
  x-transition:enter="transition ease-in-out duration-300"
  x-transition:leave="transition ease-in-out duration-300"
  class="fixed inset-0 z-40 md:hidden"
  style="display: none;"
>
    <div
    x-show="show_hamburger_menu"
    x-transition:enter="ease-in-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="ease-in-out duration-300"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    @click="show_hamburger_menu = false"
    class="absolute inset-0 bg-[var(--background-clr-god)] bg-opacity-50"
  ></div>
    <div
    class="fixed top-0 right-0 h-full w-64 sm:w-80 bg-[var(--background-clr-clear)] shadow-xl z-50"
    x-show="show_hamburger_menu"
    x-transition:enter="transition ease-in-out duration-300 transform"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in-out duration-300 transform"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
  >
      <div class="flex justify-between items-center p-4 border-b border-[var(--border-clr-subtle)]">
        <span class="font-semibold text-[var(--txt-clr-thick)]">Menu</span>
        <button type="button" class="p-2 text-[var(--txt-clr-lite)] hover:text-[var(--txt-clr-muted)]" @click="show_hamburger_menu = false">
          <span class="sr-only">Close menu</span>
          <%= icon(icon: :close_icon, options: {class: "text-xl"}) %>
        </button>
      </div>
      <div class="pt-4 pb-3 border-t border-[var(--border-clr-subtle)]">
        <div class="flex items-center px-5">
          <div class="flex-shrink-0">
            <span class="h-10 w-10 overflow-hidden rounded-full bg-[var(--background-clr-thick)] flex items-center justify-center">
              <% if current_user.profile_picture.attached? %>
                <%= image_tag url_for(current_user.profile_picture) %>
              <% else %>
                <%= icon(icon: :user_icon, options: {class: "fa-fw text-[var(--txt-clr-subtle)]"}) %>
              <% end %>
            </span>
          </div>
          <div class="ml-3">
            <div class="text-base font-medium text-[var(--txt-clr-thick)]">User Name</div>
            <div class="text-sm font-medium text-[var(--txt-clr-subtle)]">user@example.com</div>
          </div>
        </div>
        <div class="mt-3 px-2 space-y-1">
          <%= link_to user_profile_path(id: current_user.id), class: "block rounded-md px-3 py-2 text-base font-medium text-[var(--txt-clr-subtle)] hover:bg-[var(--background-clr-body)] hover:text-[var(--txt-clr-thick)]" do %>
            <%= icon(icon: :regular_user_icon, options:{class:"fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
            <%= "Your Profile" %>
          <% end %>
          <a href="#" class="block rounded-md px-3 py-2 text-base font-medium text-[var(--txt-clr-subtle)] hover:bg-[var(--background-clr-body)] hover:text-[var(--txt-clr-thick)]">
            <%= icon(icon: :gear_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
            Account Settings
          </a>
          <%= link_to site_settings_path(), class: "block rounded-md px-3 py-2 text-base font-medium text-[var(--txt-clr-subtle)] hover:bg-[var(--background-clr-body)] hover:text-[var(--txt-clr-thick)]" do %>
            <%= icon(icon: :sliders_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
            Site Settings
          <% end %>
          <div class="flex px-4 py-2 items-center justify-between z-60">
            <span class="flex-grow flex flex-col">
              <span class="text-sm font-medium text-[var(--txt-clr-default)]">Dark Mode</span>
            </span>
            <label 
      :class="{'bg-[var(--primary-600)]' : dark_mode==true, 'bg-[var(--background-clr-strong)]' : dark_mode==false}"
      class="relative inline-flex flex-shrink-0 items-center h-5 w-9 border-2 border-[var(--border-clr-default)] rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-500)]">
              <input type="checkbox" class="w-0 h-0 opacity-0" :checked="dark_mode" @change="change_theme" >
              <span
        :class="{ 'translate-x-4': dark_mode==true, 'translate-x-0': dark_mode==false }"
        class="pointer-events-none inline-block h-3 w-3 rounded-full bg-[var(--background-clr-clear)] shadow transform ring-0 transition ease-in-out duration-200"></span>
            </label>
          </div>
          <div class="border-t border-[var(--border-clr-subtle)] my-1"></div>
          <%= link_to destroy_user_session_path(), data: { turbo_method: "delete" }, class: "block rounded-md px-3 py-2 text-base font-medium text-[var(--txt-clr-subtle)] hover:bg-[var(--background-clr-body)] hover:text-[var(--txt-clr-thick)]" do %>
            <%= icon(icon: :arrow_right_from_bracket_icon, options:{class: "fa-fw mr-2 text-[var(--txt-clr-subtle)]"}) %>
            <%= "Sign out" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile hamburger menu start -->
</nav>
<div data-controller="header"
        x-show="isSearchModalOpen"
        x-cloak
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 z-50 bg-[var(--background-clr-clear)] md:hidden"
        style="display: none;"
    >
  <div class="flex flex-col h-full">
    <!-- Search Modal Header -->
    <div class="flex items-center p-2 border-b border-[var(--border-clr-subtle)] flex-shrink-0">
      <button @click="isSearchModalOpen = false" class="p-2 text-[var(--txt-clr-subtle)] hover:text-[var(--primary-600)]">
        <i class="fa-solid fa-arrow-left text-lg"></i>
      </button>
      <%= form_with url: search_index_path, method: :get do |f| %>
        <%= f.text_field :search_text,
              "@focus"=> "show_search = true",
              placeholder: "Search k-loop",
              data:{action: "input->header#seachOnChange", search_url_template: autocomplete_path(search_text:"PLACEHOLDER")},
              autocomplete: "off",
              class:"block w-full border border-[var(--border-clr-default)] rounded-md leading-5 bg-[var(--background-clr-clear)] placeholder-[var(--txt-clr-subtle)] focus:outline-none focus:placeholder-[var(--txt-clr-lite)] focus:ring-1 focus:ring-[var(--primary-500)] focus:border-[var(--primary-500)] sm:text-sm transition duration-150 ease-in-out" %>
      <% end %>
    </div>
    <!-- Search Modal Results -->
    <div class="overflow-y-auto p-2">
      <%= render partial: "shared/trending_posts", locals: {posts: [], user: current_user} %>
    </div>
  </div>
</div>
